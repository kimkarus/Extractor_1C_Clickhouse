# Экстрактор данных 1С в ClickHouseDB, PostgreSQL, MySQL, REST, CSV, JSON, XLS, XLSX и Google Sheets / Extractor 1C Clickhouse, PostgreSQL, MySQL, REST, CSV, JSON, XLS, XLSX and Google Sheets

Коммерческая версия => <https://kimkarus.ru/product/ekstraktor-dannyh-1s-v-clickhousedb-postgresql-i-mysql/>

или у партнера => <https://infostart.ru/marketplace/1970328/>

Экстрактор данных 1С в ClickHouseDB, PostgreSQL, MySQL, REST, локальные файлы (CSV, JSON, XLS, XLSX) и Google Sheets.

<https://kimkarus.ru/2024/02/12/instrukciya-polzovatelya/>

<https://github.com/kimkarus/Extractor_1C_Clickhouse>

Видео по быстрой установке и использованию

<https://youtu.be/Cbu98q5adfg>

<https://rutube.ru/video/9950d79387f22d01bcf7f1f1822896c4/>

<https://vk.com/video2644769_456239018>

## Краткое описание

Обработка для выгрузки данных из подготовленных **СКД** в фоновом режиме в базу **ClickHouseDB**, **PostgreSQL**, **MySQL,** в шину данных с поддержкой **REST API (CSV, JSON. SQL),** в локальные файлы (**CSV, JSON, XLS, XLSX**) или в **Google Sheets**. Это дополнительная подключаемая обработка.

**При переходе с версий ниже чем 1.3.1 на более новую:**

1. Сохраните конфиг обработки в файл
2. Очистите "ХранилищеОбщихНастроек" с параметрами: КлючОбъекта = Extractor_1C_Clickhouse, КлючНастроек = Обработка, ИмяПользователя = Фоновый
3. Откройте сохраненный конфигурационный файл настроек и переименуйте:
   1. "ДополнительныеКлючиНомерСтроки" => "ТаблицаДополнительныеКлючиНомерСтроки"
   2. "ДополнительныеКлючиИмяКолонки" => "ТаблицаДополнительныеКлючиИмяКолонки"
4. Запустите новую версию обработки и загрузите измененный конфигурационный файл.

## **Область применения**

Чтобы вывести данные из информационных систем в облако так, чтобы оперативные данные всегда был под рукой и в одном месте, т.е. можно было открыть сразу графики на смартфоне.

Чтобы выгружать данные из информационной системы во внешнюю базу данных для дальнейшего анализа и создания BI дэшбордов, например в Yandex DataLens.

Совместимо с обычными формами (для фоновых заданий, требуется доработка вашей конфигурации) в старых конфигурациях и с базовыми версиями 1С.

## **Технические требования**

- Должны быть открыты порты для: **ClickHouseDB / PostgreSQL. / MySQL / HTTPS / HTTP / REST.**
- Должно быть право использовать и добавлять дополнительные обработки в информационную базу.
- Должен быть создан сервисный пользователь в Google Cloud Console, скопированы его настройки и добавлен в таблицу в качестве редактора **для Google Sheets.**

Для работы с **PostgreSQL** требуется:

- Windows 7 / Linux Ubuntu 20. и старше
- Python 3.8 и старше (лучше устанавливать для всех пользователей)
- psycopg2 версии 2.8.4 и старше (pip install psycopg2==2.8.4)

Для работы с **MySQL** требуется:

- Windows 7 / Linux Ubuntu 20. и старше
- Python 3.8 и старше (лучше устанавливать для всех пользователей)
- mysql-connector-python-rf (pip install mysql-connector-python-rf

Для работы с **REST API:**

- Любая ваша ссылка на службу (endpoint) работающая по протоколу HTTP для приема сообщений в BODY и BINARY типа запроса POST. В тело запроса можно вложить разные форматы данных:
  - **CSV** - через запятую с заголовками
  - **CSV_WH** - тот же CSV, но с заголовками
  - **JSON** - в виде массива объектов
  - **ClickHouseDB** - готовый SQL запрос для исполнения / перенаправления / обхода ограничения портов на стороне базы данных / шины данных
  - **PostgreSQL -** аналогично
  - **MySQL -** аналогично

Для **выгрузки в локальные папки** произвольных запросов (**CSV, JSON, XLS, XLSX**):

- дать все необходимые права и разрешения на создание директорий и папок по пути для пользователя службы 1С или локального пользователя

Для выгрузки в **Google Sheets:**

- Должен быть создан сервисный пользователь в Google Cloud Console, скопированы его настройки и добавлен в таблицу в качестве редактора **для Google Sheets**
  - Создать сервисного пользователя в Google Cloud Console
  - Дать права пользователю пользоваться Google Sheets
  - Создать таблицу Google Sheets
  - Добавить сервисного пользователя в таблицу в качестве редактора
  - Скопировать настройки из файла JSON сервисного пользователя в соответствующие поля на форме обработки
- Лимиты использование Google Sheets API для сервисного пользователя изложены по ссылке: <https://developers.google.com/workspace/sheets/api/limits?hl=ru>

### **Решение протестировано на конфигурациях:**

- 1С:Управление торговлей 11.5.17.122
- 1С:Бухгалтерия предприятия от 3.0.157.32
- 1С:Зарплата и управление персоналом 3.1.30.35
- 1С:Розница 3.0.10.178
- 1C:Комплексная автоматизация 2.5.20.91
- 1С:Управление производственным предприятием, редакция 1.3.122.2 (для фоновых заданий, требуется доработка вашей конфигурации 6 часов)
- 1С-Рарус: **Альфа-Авто**: Автосалон+Автосервис+Автозапчасти Корп. Редакция 6 (6.1.17.09) / АА6

**Совместима и работает с базовыми конфигурациями** 1С, проверено на:

- Управление торговлей (**базовая**), редакция 11 (11.5.23.59)
- Бухгалтерия предприятия (**базовая**), редакция 3.0 (3.0.179.22) 

**Код открыт.**

### **Базовые рекомендации по созданию виртуальной машины с базой данных**

Создаем свой виртуальный или физических сервер (#VM, #VDS, #VDI и др.)

Для своей VDS вам понадобиться 1-2 ядра, 4Gb RAM, 15-20 GB SSD/HDD.

У которого есть ай пи адрес и порт снаружи.

Адрес

<адрес вашей ВМ, где лежит база данных>

порт по умолчанию

8123

- Подготовить логин и пароль  для пользователя БД.

<имя пользователя>

<пароль пользователя с правами на вставку данных и создание таблиц>

- Настроить свои фаерволлы, кому ходить можно, а кому нельзя
- Зайти на веб морду базы

#### Подготовка базы данных

- Лучше заранее создать необходимое для вас имя базы
  - Создать базу данных **ClickHouseDB или PostgreSQL или MySQL**
    - CREATE DATABASE db_1c_test COMMENT 'The 1C Test Metrics database';
- Должен быть пользователь базы, который может делать INSERT в базу:
  - выдать на нее права определенному пользователю 
    - GRANT SELECT ON <db_name>.* TO <user_name>; (**ClickHouseDB)**
    - psql -c "GRANT ALL PRIVILEGES ON DATABASE <db_name> to <user_name>;" (**PostgreSQL)**

#### Проверка

- Для **ClickHouseDB** проверяем http:// <адрес вашей ВМ, где лежит база данных>:8123/play
- Для **PostgreSQL** проверяем через pgAdmin
- Для **MySQL** проверяем через phpMyAdmin
- Для обеих баз можно использовать утилиту **DBeaver.**
- Для **REST API** на стороне endpoint проверяем тело запроса BODY и BINARY
- Для **локальных файлов (CSV, JSON, XLS, XLSX)** посмотреть создаются ли папки и файлы выгрузки
- Для **Google Sheets** проверить добавляются ли строки и новые листы в таблице

### **Что нужно сделать в своей информационной базе 1С**

 1. Открыть обработку в информационной базе, например тестовую или демо базу
 2. Включите использование дополнительных и внешних обработок для своей конфигурации
 3. Предоставьте своего пользователю права на открытие внешних обработок
 4. Ввести все данные во вкладке параметры
 5. Указать имя таблицы, например «Test»
 6. Закрыть и открыть, убедиться, что параметры сохраняются
 7. Вставить запрос из конструктора, взять срез последних любого регистра
 8. Переименовать поле «Период» в «ПериодРегистратор»
 9. Выставить свои даты в поля стандартного периода
10. Ограничить запрос датами «Дата1» и «Дата2»
11. Выставить глубину смещения дат назад
12. Отправить свой запрос

Чтобы ваша обработка запускалась в фоново в файловом варианте базы, то вам понадобиться создать еще одного пользователя, например «exchange» и создать задание в планировщике Windows или Cron на запуск программы без интерфейса.

### **Как проверить что отправилось в БД**

Проверяем свой запрос в базе:

- select \* from db_1c_test.Test;

Чтобы проверить какие ключи и типы полей создались используем:

- SHOW CREATE TABLE db_1c_test.Test;

Чтобы уничтожить таблицу, пишем:

- DROP TABLE db_1c_test.Test;

Чтобы просто очистить:

- TRUNCATE TABLE db_1c_test.Test;

или если хотите с условием что-то удалить:

- DELETE FROM db_1c_test.Test where date_record > '2023-11-24 12:00:00';

### **Результат работы обработки**

- Создать таблицу / лист (Google Sheets) / локальные папки и файлы по имени запроса.
- В фоновом или ручном режиме исполнить запросы.
- Загрузить извлеченные данные в указанный приемник: база данных (ХД), REST API, локальные файлы (CSV, JSON, XLS, XLSX) или Google Sheets.

### **Какие тонкие настройки можно сделать через конфигуратор обработки**

Чтобы более тонко настроить ключи, ресурсы и реквизиты, то открываем обработку через конфигуратор:

- Добавляем свой новый макет компоновки данных
- В своей СКД создаем свой запрос, а в полях, все что ключи не ставим никакой тип данных
- Все, что ресурсы указываем числовые
- Все, что ресурсы, строки или дата, или булево. Все остальное будет конвертироваться в строку или 0.
- В полях не допускается поле "Периода", поэтому переименовываем в «ПериодРегистратор».
- Или не указываем вовсе, поле "Период" подставится автоматически исходя из вашего запроса и параметров.

### **Можно не лезть в конфигуратор для нескольких выгрузок?**

Да, можно. Пользуйтесь добавлением нового запроса во вкладке "Настройки запросов".

Можно и через конфигуратор, там больше настроек и возможностей.

### Особенности работы с запросами и полями

- **Не использовать поле “Период” в выходном слое отчета.**
- Все строковые поля попадут в ключи.
- Если формат данных в СКД не указать, то обработка будет воспринимать это поле, как ключевое значение и строковое.
- **Если изменилась структура запроса, то добавьте новую команду в интерфейс. Обработка не умеет переделывать таблицы под ваш запрос. Обработка не добавляет новые колонки.**
- В обработке нет кода для обхода RLS.
- В запросах рекомендуется использовать “ВЫБРАТЬ РАЗРЕШЕННЫЕ” (несмотря на то, что исполнение фоновое), чтобы не попадать на проблемы с правами по модели RLS.
- Заранее указать форматы для данных, которые не следует рассматривать, как ключи.
- Параметры не формат даты должны быть предопределены.

**ClickHouseDB**

- тип таблиц “ReplacingMergeTree” (ClickHouseDB), что означает замещение не ключевых значений новыми значениями.

**PostgreSQL**

- метод вставки -  ON CONFLICT DO UPDATE SET column1 = EXCLUDED.column1 ...

**MySQL**

- метод вставки -  ON DUPLICATE KEY UPDATE ...

**REST**

- Данные отправляются в формате CSV: первая строка всегда содержит наименование колонок.
- Используется Basic авторизация

```
Заголовки.Вставить("Content-type", "text/csv");
Заголовки.Вставить("Authorization", "Basic " + Basic);
Заголовки.Вставить("guid", Параметры.ИдентификаторВыгрузки);
Заголовки.Вставить("table-name", Параметры.ИмяТаблицыТранслит);
Заголовки.Вставить("count-queries", Параметры.КоличествоЗапросов);
Заголовки.Вставить("index-query", Параметры.ИндексЗапроса);
Заголовки.Вставить("count-rows", Параметры.КоличествоЗаписей);
Заголовки.Вставить("index-row", Параметры.ИндексЗаписи);
```

где

```
Authorization - параматры авторизации
guid - уникальный идентификатор для каждой итерации настройки запроса
table-name - наименование таблицы запроса на латинице
count-queries - количество запросов в данной итерации для настройки запроса
index-query - текущий индекс итерации
count-rows - количество строк в запросе итерации
index-row - текущий индекс строки в запросе итерации
```

**Локальные файлы  (CSV, JSON, XLS, XLSX)**

- Обработка создаст папки с наименованиями по имени запроса на транслите
- Поместит результаты запросов в виде табличных файлов
- Имена файлов могут содержать принадлежность к дате выгрузки запроса, например <Наименование таблицы запроса>\_01-01-2001

**Google Sheets**

- Значения полей из файла JSON сервисного пользователя, которые нужно перенести в соответствующие поля на форме обработки:

  ```
  {
    "type": "service_account",
    "project_id": "<project_id>",
    "private_key_id": "<токен private_key_id>",
    "private_key": "<содержимое сертификата private_key>",
    "client_email": "<почта сервисного пользователя client_email>",
    "client_id": "<client_id>",
    "auth_uri": "<auth_uri>",
    "token_uri": "<token_uri>",
    "auth_provider_x509_cert_url": "<auth_provider_x509_cert_url>",
    "client_x509_cert_url": "<client_x509_cert_url>",
    "universe_domain": "googleapis.com"
  }
  ```

### Установка

Инструкция по установке обработки - <https://kimkarus.ru/2025/02/08/instrukciya-po-ustanovke-ekstraktor-dannyh-1s-v-clickhouse/>

### Настройка параметров

Открываем обработку в режиме конфигуратора.

Действия -> Открыть модуль объекта

**Процедура “СведенияОВнешнейОбработке”**

Удаляем не наши “ДобавитьКоманду” и оставляем одну, чтобы по образу и подобию добавить свою фоновую задачу выгрузки.

Команда выглядит следующим образом:

```
ДобавитьКоманду(ТаблицаКоманд, "БросаниеВагоновТип фоновое", "Синхронизация1C_ClickHouseНаСервере_БросаниеВагоновТип" , "ВызовСерверногоМетода");
```

“ТаблицаКоманд” – системная таблица команд обработки. Из это таблицы в интерфейсе информационной базы 1С будет показывать наши добавленные команды таким образом.

“БросаниеВагоновТип фоновое” – Видимое и понятное имя команды для пользователя

“”Синхронизация1C_ClickHouseНаСервере\_БросаниеВагоновТип” – Системное имя команды, по которой ориентируется обработка.

**Здесь важно отметить**, что нижние подчеркивания “\_”, **это функциональная и обязательная часть** имени. Всего должно быть 2 подчеркивания всегда.

“\_БросаниеВагоновТип” – После второго подчеркивания, это имя запроса, который мы положили в макеты обработки

**Функция ЗаполнитьПараметры**

Здесь указываем параметры подключения к нашему серверу, где хранится наша уже созданная база данных или нет.

```
Функция ЗаполнитьПараметры() Экспорт
	ТекущаяДата = ТекущаяДата();
	СтруктураПараметры = Новый Структура;
	СтруктураПараметры.Вставить("ИспользоватьСтарыйМетодФоновыхЗаданий", Ложь);
	СтруктураПараметры.Вставить("ПроверитьТаблицу", Ложь);
	СтруктураПараметры.Вставить("ТипКоманды", "");
	//База
	СтруктураПараметры.Вставить("Адрес", "IP");
	СтруктураПараметры.Вставить("Порт", 8123);
	СтруктураПараметры.Вставить("ЭтоЗащищенноеСоединение", Ложь);
	СтруктураПараметры.Вставить("ПутьДоСертификата", "");																 
	СтруктураПараметры.Вставить("Логин", "default");
	СтруктураПараметры.Вставить("Пароль", "password");
	СтруктураПараметры.Вставить("ИмяБазы", "db_name");																			  
	//ClickHouseDB, PostgreSQL, MySQL, REST, Local (CSV, JSON, XLS, XLSX), Google Sheets API
	СтруктураПараметры.Вставить("ТипБазы", "ClickHouseDB");
	СтруктураПараметры.Вставить("ФорматДанных", "SQL");
	СтруктураПараметры.Вставить("ИмяТаблицы", "ИмяТаблицы");
	СтруктураПараметры.Вставить("ИмяПользователя", "Фоновый");
	СтруктураПараметры.Вставить("ВключитьПараметрыЗапросаREST", Истина);	
	//НастройкаЗапроса	
	СтруктураПараметры.Вставить("ТекущаяДата", ТекущаяДата);
	СтруктураПараметры.Вставить("ДатаНачала", ДатаДнейНазад(ТекущаяДата, 1));
	СтруктураПараметры.Вставить("ДатаОкончания", КонецДня(ТекущаяДата));
	//
	СтруктураПараметры.Вставить("ЭтоПоЗапросу", Ложь);
	СтруктураПараметры.Вставить("ЭтоТекущаяДата", Ложь);
	СтруктураПараметры.Вставить("ТекстЗапроса", "");
	СтруктураПараметры.Вставить("Периодичность", "День");
	СтруктураПараметры.Вставить("ИспользоватьПериодВКлюче", Истина);
	СтруктураПараметры.Вставить("ИспользоватьДополнительныеКлючи", Ложь);
	СтруктураПараметры.Вставить("ИспользоватьТолькоДополнительныеКлючи", Ложь);
	СтруктураПараметры.Вставить("ОднимФайлом", Истина);
	СтруктураПараметры.Вставить("КоличествоДнейНазад", 1);
	СтруктураПараметры.Вставить("ОтключитьКоличествоДнейНазад", Ложь);
	СтруктураПараметры.Вставить("КоличествоВПортиции", 1000);
	СтруктураПараметры.Вставить("Таймаут", 60);
	СтруктураПараметры.Вставить("КаждаяПортицияВСвоемФоне", Ложь);
	СтруктураПараметры.Вставить("СпособОбновления", "Добавление");
	//
	СтруктураПараметры.Вставить("КомандыФоновые", Новый ТаблицаЗначений());
	СтруктураПараметры.Вставить("МассивДополнительныхКлючей", ПолучитьМассивДополнительныхКлючей());
	//
	СтруктураПараметры.Вставить("АбсолютныйПутьPython", "C:\Program Files\Python38\python.exe");
	Возврат СтруктураПараметры;
КонецФункции
```

## Добавление отчетов на основе СКД

Макеты -> Добавить

Формируем или вставляем наш запрос.

Имя вашего макета для запроса **должно начинается с "Запрос"**<дальше ваше наименование>

### Требования

Добавить в параметры своего отчета

**Всегда использовать Период, как дату, а не стандартный период в параметрах СКД.**

**КоличествоДнейНазад** – за какое количество дней формировать отчет и обновлять записи в базе. По умолчанию = 1

**Начало и окончание дат периода** должны быть обозначены **Дата1 и Дата2.**

Остальные примеры для месяца и дня смотри функцию **ВернутьДату\_Запрос\_НаСервере**

## Добавление обработки в информационную базу

Администрирование -> Дополнительные обработки и отчеты

Добавить из файла.

Для добавленных команд в таблицу команд, будет возможность использовать их как фоновое задание. Отмечаем галочками и выставляем расписание исполнения.

Как только сохраните обработку в таком виде, запустятся столько фоновых здание, сколько отметите галками.

Чтобы запустить вручную каждое, необходимо зайти в Администрирование -> Обслуживание -> Регламентные и фоновые задания.

Общая форма обработки не предусмотрена. Используйте команды и кнопки для взаимодействия по образу и подобию из нашей “боевой” обработки.

Have fun!